# Platform Apps Support

> For more specific info related to platform app, please check [the official docs](https://bo.wix.com/wix-docs/client/editor-platform/editor-application-reference/editor-platform-app)

### Intro

<img width="790" alt="Screen Shot 2020-04-21 at 1 06 17 PM" src="https://user-images.githubusercontent.com/1521229/79906725-028fff00-8421-11ea-934b-660adef18180.png">

After understanding that we have a lot of things in common between platform apps and out-of-iframe apps,
we decided to combine efforts and allow yoshi to support platform apps.
This means 2 big things for the future of the development apps inside Wix:

Firstly, if you are developing out-of-iframe app and want to migrate it gradually to platform app, you don't have to create a new project. Imagine you have 2 components in your out-of-iframe app: products list and product page.
You want to allow your users to get all the benefits of platform's apps. Configuring each element in the list using already created native components sounds promising!
But creating a new project from scratch could take time. A lot of functional logic will be just copy-pasted. You basically have to remove `Widget.ts` containing
React Component and make all the UI magic inside the viewer controller. So by using editor flow you can just do this w/o new bootstrap.
Yoshi is smart enough to understand what kind of component it needs to handle.

The second win is a learning curve. We are trying to find more things in common between the platform and OOI apps, so most of the configuration options, way we are developing
locally, serving Settings Panel App, running tests, etc should be almost the same. Both types of apps have a controller for viewer part -`viewer.controller.ts`, entry points for worker bundles: `viewer.app.ts`, `editor.app.ts`, Settings panel, rendered via React  - `Settings.ts`.

### App structure

```
app
│   .application.json
│
└───src
    │   editor.app.ts
    │   viewer.app.ts
    │
    └───components
        └───ProductList
        │   .component.json
        │   editor.controller.ts
        │   viewer.controller.ts
        │   Settings.ts
        │
        └───ProductPage
            .component.json
            editor.controller.ts
            viewer.controller.ts
```

### Components
Each application consists of components. All components' files are grouped by directories located in `components` directory.
For platform apps, the main parts of the component are `editor.controller.ts` and `viewer.controller.ts`.

#### `viewer.controller.ts`
It's a controller for the viewer UI part. Each controller is being mapped with `controllerConfigs` provided by the platform under the hood based on the component ID in `.component.json`.
Here we are creating a platform Widget, add UI handlers for it, providing other component's functional logic.
This file should `export default` a single function generated by `widgetScriptBuilder`:

```ts
function createViewerController({ $w, controllerConfig, appData, wixCodeApi }) {
    return {
        pageReady() {
            $w('#name').text = 'Hello!';
            // ...
        }
    }
}

export default widgetScriptBuilder()
  .withCreateMethod(createViewerController)
  .build();
```

#### `editor.controller.ts`
A Controller for the editor part. Under the hood, it's going to be collected and processed in the `editorScript`.

```ts
export default function(): WidgetEditor {
  return {
    type: widgetId,
    getStageData() {
        return widgetStageData;
    },
    getVariations() {
        return {
          variations: variationPresets,
          options: {
            presetsPanelTitle: 'Change layout',
          },
        };
      },
  };
}
```


### App Entry Points (`viewer.app.ts`, `editor.app.ts`)
Both `viewerScript` (bundle that maps user's `viewer.controller`s with controller configs inside `createControllers` function) and `editorScript` (bundle that collects all `editor.controller`s in a single place) are generated by yoshi automatically.
But you can still override values which are supported by the platform for these kinds of files.

#### `viewer.app.ts`
Here we'll map lifecycle methods provided by platform and add useful helpers provided by the flow. Note that you can't override `createControllers` function.
- `initAppForPage` *(platform)* - https://bo.wix.com/wix-docs/client/client-viewer-platform/articles/lifecycle#client-viewer-platform_articles_lifecycle_initappforpage
- `mapPlatformStateToAppData` *(flow)* - this function will be executed once before executing each of the controller. It has access to some initial data like `controllerConfigs`, `platformParams` and `frameworkData` and could be useful for initializing the app and passing some value to each of controllers as an `appData` field.

`viewer.app.ts`
```ts
export const mapPlatformStateToAppData = async ({
    platformParams,
    controllerConfigs,
    frameworkData,
}: any) => {
    const someInitialData = await getInitialData();
    return { someInitialData }; // Will be available in `viewer.controller`
};

export const initAppForPage = () => {
    console.log('App inited!');
};
```

#### `editor.app.ts`
An Entry-point for the `editor` bundle. For more info read [editor app docs](https://bo.wix.com/wix-docs/client/editor-platform/platform-articles/application-structure-and-lifecycle#editor-platform_platform-articles_application-structure-and-lifecycle_application-life-cycle-and-structure)
You can use `editorScriptBuilder` to build editor script by configuring it using your manifest, app's event handler and registering editor.controller.

In the future, we'll register the widget under the hood as we do for `viewerScript`.

```ts
import productWidget from './components/ProductPage/editor.controller';

export default editorScriptBuilder()
  .withEditorReady(editorReady)
  .withAppManifest(appManifest)
  .withEventHandler(eventHandler)
  .withWidget(productWidget)
  .build();
```

### App configuration files (`.application.json`, `.component.json`)
As you noticed, we are using "magic" to reduce boilerplate in many parts of the app. We are going to improve it in the future, so in the future we're going to simplify `editor.app.ts` as well.
To bring it to life we need some pre-configuration from the user.

#### `.application.json`
This is a configuration JSON object located in the project's root. Here we should specify `"appDefinitionId"` from the Dev Center. Yoshi uses it to override URLs during the local development to point viewerScript and editorScript bundles to the local code served by flow.
#### `.component.json`
Each component should contain a single configuration file in the component's directory root. We support only `"id"` field, which is controller `type` that you defined when you created and added the controller to the stage. It's needed in order to match between each controller config to its matching controller logic and for URL overrides for local development.
